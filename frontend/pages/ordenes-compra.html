<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="../img/cielitohome.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ìrdenes de Compra - Sistema Cielito Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <link href="../css/ux-improvements.css" rel="stylesheet">
    <link href="../css/pro-enhancements.css" rel="stylesheet">
    <link href="../css/sidebar-collapsible.css" rel="stylesheet">
    <link href="../css/navbar-responsive-fix.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>
    <div class="container-fluid">
        <div class="row">
            <div id="sidebar-container"></div>
            <main class="px-md-4">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h1 class="page-title">
                                <i class="fas fa-receipt me-2"></i>
                                √ìrdenes de Compra
                            </h1>
                            <p class="mb-0 opacity-75">Gestiona las √≥rdenes de compra generadas</p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-light" id="newOrderBtn">
                                <i class="fas fa-plus me-2"></i>
                                Nueva Orden
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="ordersTable" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Folio</th>
                                        <th>Solicitud</th>
                                        <th>Proveedor</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para Nueva Orden -->
    <div class="modal fade" id="newOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt me-2"></i>
                        Nueva Orden de Compra
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="newOrderForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="requestId" class="form-label">Solicitud Autorizada *</label>
                            <select class="form-select" id="requestId" required>
                                <option value="">Seleccione una solicitud...</option>
                            </select>
                            <small class="text-muted">Solo solicitudes autorizadas con cotizaci√≥n seleccionada</small>
                        </div>

                        <div id="quotationInfo" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">Resumen de Items Seleccionados</h6>
                                <div id="selectedItemsSummary">
                                    <!-- Se llenar√° din√°micamente -->
                                </div>
                                <hr>
                                <p class="mb-0"><strong>Total General:</strong> <span id="quotationTotal" class="fs-5 text-success">-</span></p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="orderDate" class="form-label">Fecha de Orden *</label>
                                <input type="date" class="form-control" id="orderDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="expectedDelivery" class="form-label">Fecha Esperada de Entrega</label>
                                <input type="date" class="form-control" id="expectedDelivery">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="orderNotes" class="form-label">Notas Adicionales</label>
                            <textarea class="form-control" id="orderNotes" rows="3"
                                      placeholder="Instrucciones especiales, condiciones, etc."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Crear Orden de Compra
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Canvas Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Load environment config FIRST -->
    <script src="../js/env.js?v=20251111"></script>
    <script src="../js/config.js?v=20251111v5"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/init.js"></script>
    <script src="../js/auth.js"></script>
    <!-- PRO Enhancements -->
    <script src="../js/pro-enhancements.js"></script>
    <script src="../js/sidebar-collapsible.js"></script>
    <script>
        let ordersTable;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ P√°gina de √≥rdenes cargada');

            const user = Utils.getCurrentUser();
            if (!user || !Utils.hasPermission(user.role, ['purchaser', 'admin'])) {
                Utils.showToast('No tienes permisos para acceder a esta p√°gina', 'error');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                return;
            }

            await loadComponents();
            initTable();
            setupEventListeners();
        });

        function initTable() {
            ordersTable = $('#ordersTable').DataTable({
                ...CONFIG.DATATABLE_CONFIG,
                ajax: {
                    url: CONFIG.API_URL + '/orders',
                    type: 'GET',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    dataSrc: json => json.success ? json.data.orders : []
                },
                columns: [
                    { data: 'folio' },
                    { data: 'request_folio' },
                    { data: 'supplier_name' },
                    { data: 'order_date', render: data => Utils.formatDate(data) },
                    { data: 'total_amount', render: data => Utils.formatCurrency(data) },
                    {
                        data: 'status',
                        render: data => {
                            const colors = {
                                emitida: 'primary',
                                en_transito: 'info',
                                recibida: 'success',
                                cancelada: 'danger'
                            };
                            return `<span class="badge bg-${colors[data]}">${CONFIG.ESTATUS_ORDERS[data] || data}</span>`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: (data, type, row) => `
                            <div class="btn-group">
                                <a href="detalle-orden.html?id=${row.id}"
                                   class="btn btn-sm btn-info" title="Ver Detalles">
                                    <i class="fas fa-eye"></i>
                                </a>
                                ${row.status === 'recibida' ? `
                                <button onclick="downloadOrderPDF(${row.id}, '${row.folio}')"
                                   class="btn btn-sm btn-primary" title="Descargar PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                                ` : ''}
                            </div>
                        `
                    }
                ]
            });
        }

        function setupEventListeners() {
            // Bot√≥n nueva orden
            document.getElementById('newOrderBtn').addEventListener('click', async function() {
                await loadAuthorizedRequests();
                const modal = new bootstrap.Modal(document.getElementById('newOrderModal'));
                modal.show();
            });

            // Cuando se selecciona una solicitud, cargar su cotizaci√≥n
            document.getElementById('requestId').addEventListener('change', async function() {
                const requestId = this.value;
                if (requestId) {
                    await loadQuotationInfo(requestId);
                } else {
                    document.getElementById('quotationInfo').style.display = 'none';
                }
            });

            // Formulario de nueva orden
            document.getElementById('newOrderForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createOrder();
            });

            // Establecer fecha actual por defecto
            document.getElementById('orderDate').valueAsDate = new Date();
        }

        async function loadAuthorizedRequests() {
            try {
                console.log('üîÑ Cargando solicitudes autorizadas...');
                const response = await fetch(`${CONFIG.API_URL}/requests?status=autorizada`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                const data = await response.json();
                console.log('üì¶ Respuesta solicitudes autorizadas:', data);

                const select = document.getElementById('requestId');
                select.innerHTML = '<option value="">Seleccione una solicitud...</option>';

                if (data.success && data.data.requests) {
                    console.log(`üìã Total solicitudes autorizadas: ${data.data.requests.length}`);

                    // Filtrar solo solicitudes con cotizaci√≥n seleccionada
                    const requestsWithQuotation = data.data.requests.filter(r => r.has_selected_quotation > 0);
                    console.log(`‚úÖ Solicitudes con cotizaci√≥n seleccionada: ${requestsWithQuotation.length}`);

                    requestsWithQuotation.forEach(request => {
                        console.log(`  - ${request.folio}: has_selected_quotation = ${request.has_selected_quotation}`);
                        const option = document.createElement('option');
                        option.value = request.id;
                        option.textContent = `${request.folio} - ${request.area}`;
                        select.appendChild(option);
                    });

                    if (requestsWithQuotation.length === 0) {
                        console.warn('‚ö†Ô∏è No hay solicitudes con cotizaci√≥n seleccionada');
                        Utils.showToast('No hay solicitudes autorizadas con cotizaci√≥n seleccionada', 'warning');
                    }
                } else {
                    console.error('‚ùå Error en respuesta:', data);
                }
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                Utils.showToast('Error al cargar solicitudes', 'error');
            }
        }

        let currentQuotationId = null; // Variable global para guardar el quotation_id

        async function loadQuotationInfo(requestId) {
            try {
                // Primero cargar la solicitud para obtener la fecha de entrega esperada
                const requestResponse = await fetch(`${CONFIG.API_URL}/requests/${requestId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const requestData = await requestResponse.json();

                // Auto-completar la fecha de entrega esperada si existe
                if (requestData.success && requestData.data && requestData.data.delivery_date) {
                    document.getElementById('expectedDelivery').value = requestData.data.delivery_date;
                }

                // Primero cargar los items seleccionados para calcular el total real
                const selectedItemsResponse = await fetch(`${CONFIG.API_URL}/quotations/request/${requestId}/selected-items`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const selectedItemsData = await selectedItemsResponse.json();

                const response = await fetch(`${CONFIG.API_URL}/quotations/request/${requestId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                const data = await response.json();

                if (data.success && data.data) {
                    // Buscar cotizaci√≥n seleccionada o cotizaci√≥n con items seleccionados
                    let selectedQuotation = data.data.find(q => q.is_selected === true || q.is_selected === 1);

                    // Si no hay cotizaci√≥n completa seleccionada, buscar la que tenga m√°s items seleccionados
                    if (!selectedQuotation && selectedItemsData.success && selectedItemsData.data.length > 0) {
                        // Agrupar items por quotation_id para encontrar la cotizaci√≥n principal
                        const quotationCounts = {};
                        selectedItemsData.data.forEach(item => {
                            const quotation = data.data.find(q => q.supplier_name === item.supplier_name);
                            if (quotation) {
                                quotationCounts[quotation.id] = (quotationCounts[quotation.id] || 0) + 1;
                            }
                        });

                        // Encontrar la cotizaci√≥n con m√°s items seleccionados
                        const maxQuotationId = Object.keys(quotationCounts).reduce((a, b) =>
                            quotationCounts[a] > quotationCounts[b] ? a : b, null);

                        if (maxQuotationId) {
                            selectedQuotation = data.data.find(q => q.id === parseInt(maxQuotationId));
                        }
                    }

                    if (selectedItemsData.success && selectedItemsData.data.length > 0) {
                        // Agrupar items por proveedor
                        const supplierGroups = {};
                        let totalAmount = 0;

                        selectedItemsData.data.forEach(item => {
                            const supplierName = item.supplier_name;
                            if (!supplierGroups[supplierName]) {
                                supplierGroups[supplierName] = {
                                    items: [],
                                    total: 0
                                };
                            }
                            supplierGroups[supplierName].items.push(item);
                            supplierGroups[supplierName].total += parseFloat(item.subtotal || 0);
                            totalAmount += parseFloat(item.subtotal || 0);
                        });

                        // Generar HTML del resumen
                        let summaryHtml = '';
                        Object.keys(supplierGroups).forEach(supplierName => {
                            const group = supplierGroups[supplierName];
                            summaryHtml += `
                                <div class="mb-2">
                                    <strong>${supplierName}</strong> - ${Utils.formatCurrency(group.total)}
                                    <ul class="mb-1 small">
                            `;
                            group.items.forEach(item => {
                                summaryHtml += `<li>${item.material} (${item.quantity} ${item.unit}) - ${Utils.formatCurrency(item.subtotal)}</li>`;
                            });
                            summaryHtml += '</ul></div>';
                        });

                        document.getElementById('selectedItemsSummary').innerHTML = summaryHtml;
                        document.getElementById('quotationTotal').textContent = Utils.formatCurrency(totalAmount);

                        // Guardar el quotation_id del proveedor principal (el que tiene m√°s items)
                        if (selectedQuotation) {
                            currentQuotationId = selectedQuotation.id;
                        }

                        document.getElementById('quotationInfo').style.display = 'block';
                    } else if (selectedQuotation) {
                        // Fallback: mostrar info de cotizaci√≥n √∫nica
                        currentQuotationId = selectedQuotation.id;
                        document.getElementById('selectedItemsSummary').innerHTML = `
                            <p class="mb-1"><strong>Proveedor:</strong> ${selectedQuotation.supplier_name || '-'}</p>
                            <p class="mb-0"><strong>D√≠as de entrega:</strong> ${selectedQuotation.delivery_days ? selectedQuotation.delivery_days + ' d√≠as' : 'No especificado'}</p>
                        `;
                        document.getElementById('quotationTotal').textContent = Utils.formatCurrency(selectedQuotation.total_amount);
                        document.getElementById('quotationInfo').style.display = 'block';
                    } else {
                        Utils.showToast('No se encontr√≥ cotizaci√≥n seleccionada', 'error');
                    }
                }
            } catch (error) {
                console.error('Error cargando cotizaci√≥n:', error);
                Utils.showToast('Error al cargar informaci√≥n de cotizaci√≥n', 'error');
            }
        }

        async function createOrder() {
            const requestId = document.getElementById('requestId').value;
            const orderDate = document.getElementById('orderDate').value;
            const expectedDelivery = document.getElementById('expectedDelivery').value;
            const notes = document.getElementById('orderNotes').value;

            if (!requestId) {
                Utils.showToast('Debe seleccionar una solicitud', 'error');
                return;
            }

            if (!currentQuotationId) {
                Utils.showToast('No se encontr√≥ la cotizaci√≥n seleccionada', 'error');
                return;
            }

            try {
                Utils.showSpinner();

                const response = await fetch(`${CONFIG.API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        request_id: parseInt(requestId),
                        quotation_id: currentQuotationId,
                        order_date: orderDate,
                        expected_delivery: expectedDelivery || null,
                        notes: notes || null
                    })
                });

                const data = await response.json();

                Utils.hideSpinner();

                if (response.ok && data.success) {
                    Utils.showToast('Orden de compra creada exitosamente', 'success');

                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newOrderModal'));
                    modal.hide();

                    // Limpiar formulario
                    document.getElementById('newOrderForm').reset();
                    document.getElementById('quotationInfo').style.display = 'none';

                    // Recargar tabla
                    ordersTable.ajax.reload();
                } else {
                    Utils.showToast(data.message || 'Error al crear orden de compra', 'error');
                }

            } catch (error) {
                Utils.hideSpinner();
                console.error('Error creando orden:', error);
                Utils.showToast('Error al crear orden de compra', 'error');
            }
        }

        // Funci√≥n para descargar PDF de orden de compra
        async function downloadOrderPDF(orderId, orderFolio) {
            try {
                Utils.showToast('Generando PDF...', 'info');

                const response = await fetch(`${CONFIG.API_URL}/orders/${orderId}/pdf`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al generar PDF');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Orden_${orderFolio || orderId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                Utils.showToast('PDF descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error descargando PDF:', error);
                Utils.showToast('Error al descargar PDF: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
