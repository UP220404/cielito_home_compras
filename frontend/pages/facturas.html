<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="../img/cielitohome.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturas - Sistema de Compras</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Estilos específicos para facturas */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 1rem;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--cielito-primary);
            margin-bottom: 0.25rem;
        }

        .stat-card .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .stat-card.stat-success .stat-value {
            color: var(--success);
        }

        .stat-card.stat-danger .stat-value {
            color: var(--danger);
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: linear-gradient(135deg, var(--cielito-primary) 0%, var(--cielito-primary-dark) 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 1.25rem 1.5rem;
            border-bottom: none;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header h1 {
            color: var(--text-dark);
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-header h1 i {
            color: var(--cielito-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--cielito-primary) 0%, var(--cielito-primary-dark) 100%);
            border: none;
            padding: 0.625rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: var(--light-gray);
            color: var(--text-dark);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding: 1rem;
            font-size: 0.9rem;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .table tbody tr:hover {
            background-color: var(--cielito-primary-alpha);
        }

        .btn-sm.btn-icon {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            transition: all 0.2s;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        .btn-sm.btn-icon:hover {
            background: var(--cielito-primary);
            border-color: var(--cielito-primary);
            color: white;
            transform: scale(1.1);
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 0.625rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--cielito-primary);
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.15);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--cielito-primary) 0%, var(--cielito-primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-header .close {
            color: white;
            font-size: 2rem;
            font-weight: 300;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-header .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .alert {
            border-radius: 10px;
            border: none;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            background-color: rgba(25, 135, 84, 0.1);
            color: var(--success-dark);
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #856404;
        }

        .alert-info {
            background-color: rgba(23, 162, 184, 0.1);
            color: #0c5460;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -0.5rem;
        }

        .col-md-3, .col-md-12 {
            padding: 0 0.5rem;
        }

        .col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
        }

        .col-md-12 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        @media (max-width: 768px) {
            .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .mb-4 {
            margin-bottom: 1.5rem;
        }

        .mt-3 {
            margin-top: 1rem;
        }

        .text-center {
            text-align: center;
        }

        .btn-secondary {
            background-color: var(--dark-gray);
            border: none;
            padding: 0.625rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-block {
            width: 100%;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div id="sidebar-container"></div>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="page-header">
                <h1><i class="fas fa-file-invoice-dollar"></i> Gestión de Facturas</h1>
                <button id="addInvoiceBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nueva Factura
                </button>
            </div>

            <!-- Reporte Mensual -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3><i class="fas fa-chart-pie"></i> Reporte Mensual de Facturación</h3>
                </div>
                <div class="card-body">
                    <div id="monthlyReport" class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalExpenses">$0.00</div>
                                <div class="stat-label">Gastos del Mes</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalInvoiced">$0.00</div>
                                <div class="stat-label">Total Facturado</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalTax">$0.00</div>
                                <div class="stat-label">IVA Recaudado</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" id="healthCard">
                                <div class="stat-value" id="taxBalance">$0.00</div>
                                <div class="stat-label" id="healthMessage">Estado Financiero</div>
                            </div>
                        </div>
                    </div>

                    <div class="alert mt-3" id="healthAlert" style="display: none;"></div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h4>Cálculo de Facturación Requerida</h4>
                            <p id="requiredInvoicing"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label>Mes</label>
                            <select id="filterMonth" class="form-control">
                                <option value="">Todos</option>
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06">Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Año</label>
                            <select id="filterYear" class="form-control"></select>
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <button id="applyFilters" class="btn btn-primary btn-block">
                                <i class="fas fa-filter"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Facturas -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Facturas Registradas</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Folio Factura</th>
                                    <th>Fecha</th>
                                    <th>Orden de Compra</th>
                                    <th>Proveedor</th>
                                    <th>Subtotal</th>
                                    <th>IVA</th>
                                    <th>Total</th>
                                    <th>Archivo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando facturas...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </main>
        </div>
    </div>

    <!-- Modal para Ver Detalles de Factura -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice me-2"></i>Detalles de Factura</h2>
                <span class="close" onclick="closeViewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Folio:</strong>
                        <p id="viewInvoiceNumber" class="mb-2">-</p>
                    </div>
                    <div class="col-6">
                        <strong>Fecha:</strong>
                        <p id="viewInvoiceDate" class="mb-2">-</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Orden de Compra:</strong>
                        <p id="viewOrderNumber" class="mb-2">-</p>
                    </div>
                    <div class="col-6">
                        <strong>Área:</strong>
                        <p id="viewArea" class="mb-2">-</p>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Proveedor(es):</strong>
                    <p id="viewSuppliers" class="mb-2">-</p>
                </div>
                <hr>
                <div class="row mb-3">
                    <div class="col-4">
                        <strong>Subtotal:</strong>
                        <p id="viewSubtotal" class="mb-0 fs-5">-</p>
                    </div>
                    <div class="col-4">
                        <strong>IVA:</strong>
                        <p id="viewTax" class="mb-0 fs-5">-</p>
                    </div>
                    <div class="col-4">
                        <strong>Total:</strong>
                        <p id="viewTotal" class="mb-0 fs-5 fw-bold text-success">-</p>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Notas:</strong>
                    <p id="viewNotes" class="mb-2 text-muted">-</p>
                </div>
                <div class="mb-3">
                    <strong>Registrado por:</strong>
                    <p id="viewCreatedBy" class="mb-2">-</p>
                </div>
                <div id="viewFileSection" class="mb-3" style="display: none;">
                    <strong>Archivo adjunto:</strong>
                    <div class="mt-2">
                        <button class="btn btn-outline-primary" id="viewFileBtn" onclick="openInvoiceFile()">
                            <i class="fas fa-file-pdf me-1"></i> Ver archivo
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeViewModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva/Editar Factura -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nueva Factura</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <input type="hidden" id="invoiceId">

                    <div class="form-group">
                        <label for="orderId">Orden de Compra *</label>
                        <select id="orderId" class="form-control" required>
                            <option value="">Seleccione una orden...</option>
                        </select>
                    </div>

                    <div class="form-group" id="supplierSelectGroup" style="display: none;">
                        <label for="supplierId">Proveedor a Facturar *</label>
                        <select id="supplierId" class="form-control" required>
                            <option value="">Seleccione un proveedor...</option>
                        </select>
                        <small class="text-muted">Seleccione el proveedor para esta factura</small>
                    </div>

                    <div class="form-group">
                        <label for="invoiceNumber">Folio de Factura (Autogenerado)</label>
                        <input type="text" id="invoiceNumber" class="form-control"
                               placeholder="Ej: FAC-2025-01-001" readonly>
                    </div>

                    <div class="form-group">
                        <label for="invoiceDate">Fecha de Factura *</label>
                        <input type="date" id="invoiceDate" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="subtotal">Subtotal *</label>
                        <input type="number" id="subtotal" class="form-control"
                               step="0.01" min="0" required readonly>
                        <small class="text-muted">Se calcula automáticamente desde la orden</small>
                    </div>

                    <div class="form-group">
                        <label for="taxAmount">IVA (16%) *</label>
                        <input type="number" id="taxAmount" class="form-control"
                               step="0.01" min="0" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="totalAmount">Total *</label>
                        <input type="number" id="totalAmount" class="form-control"
                               step="0.01" min="0" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="invoiceFile">Archivo de Factura (PDF, JPG, PNG - Max 5MB)</label>
                        <input type="file" id="invoiceFile" class="form-control"
                               accept=".pdf,.jpg,.jpeg,.png">
                        <small class="text-muted">Sube el PDF o imagen de la factura</small>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notas</label>
                        <textarea id="notes" class="form-control" rows="3"
                                  placeholder="Comentarios adicionales..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveInvoiceBtn">
                    <i class="fas fa-save"></i> Guardar Factura
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/init.js"></script>
    <script src="../js/facturas.js"></script>
</body>
</html>
