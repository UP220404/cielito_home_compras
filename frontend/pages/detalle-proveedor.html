<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="../img/cielitohome.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Proveedor - Sistema Cielito Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <link href="../css/ux-improvements.css" rel="stylesheet">
    <link href="../css/pro-enhancements.css" rel="stylesheet">
    <link href="../css/sidebar-collapsible.css" rel="stylesheet">
    <link href="../css/navbar-responsive-fix.css" rel="stylesheet">
    <link href="../css/quick-fixes.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>
    <div class="container-fluid">
        <div class="row">
            <div id="sidebar-container"></div>
            <main class="px-md-4">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <button class="btn btn-light btn-sm mb-2" onclick="history.back()">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <h1 class="page-title">
                                <i class="fas fa-building me-2"></i>
                                <span id="supplierName">Cargando...</span>
                            </h1>
                            <p class="mb-0 opacity-75">Información completa del proveedor</p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-light" id="editSupplierBtn">
                                <i class="fas fa-edit me-2"></i>
                                Editar
                            </button>
                            <button class="btn btn-outline-danger" id="toggleActiveBtn">
                                <i class="fas fa-ban me-2"></i>
                                <span id="toggleActiveText">Desactivar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Información del Proveedor -->
                <div class="row mb-4">
                    <!-- Datos Generales -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información General
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="text-muted small">Nombre</label>
                                    <div class="fw-bold" id="detailName">-</div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">RFC</label>
                                    <div id="detailRfc">-</div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Categoría</label>
                                    <div>
                                        <span class="badge bg-info" id="detailCategory">-</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Calificación</label>
                                    <div id="detailRating">
                                        <i class="fas fa-star text-warning"></i> -
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Estado</label>
                                    <div>
                                        <span class="badge" id="detailStatus">-</span>
                                    </div>
                                </div>
                                <div class="mb-0">
                                    <label class="text-muted small">Fecha de Registro</label>
                                    <div id="detailCreatedAt">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos de Contacto -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-address-book me-2"></i>
                                    Datos de Contacto
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="text-muted small">Persona de Contacto</label>
                                    <div id="detailContactName">-</div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Teléfono</label>
                                    <div>
                                        <a href="#" id="detailPhone" class="text-decoration-none">
                                            <i class="fas fa-phone me-2"></i>-
                                        </a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Email</label>
                                    <div>
                                        <a href="#" id="detailEmail" class="text-decoration-none">
                                            <i class="fas fa-envelope me-2"></i>-
                                        </a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Dirección</label>
                                    <div id="detailAddress">-</div>
                                </div>
                                <div class="mb-0">
                                    <label class="text-muted small">Notas</label>
                                    <div class="text-muted" id="detailNotes">Sin notas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary mb-0" id="statQuotations">0</h3>
                                <p class="text-muted mb-0">Cotizaciones</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success mb-0" id="statOrders">0</h3>
                                <p class="text-muted mb-0">Órdenes Compra</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning mb-0" id="statTotal">$0</h3>
                                <p class="text-muted mb-0">Monto Total</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info mb-0" id="statWinRate">0%</h3>
                                <p class="text-muted mb-0">Tasa de Éxito</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial de Cotizaciones -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-invoice-dollar me-2"></i>
                            Historial de Cotizaciones
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="quotationsTable" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Folio Solicitud</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>Días Entrega</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para Editar Proveedor -->
    <div class="modal fade" id="editSupplierModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Editar Proveedor
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="editSupplierForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editName" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editRfc" class="form-label">RFC</label>
                                <input type="text" class="form-control" id="editRfc" maxlength="13">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editContactName" class="form-label">Persona de Contacto</label>
                                <input type="text" class="form-control" id="editContactName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editPhone" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="editPhone">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCategory" class="form-label">Categoría</label>
                                <input type="text" class="form-control" id="editCategory"
                                       placeholder="Ej: Materiales, Servicios, etc.">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Dirección</label>
                            <textarea class="form-control" id="editAddress" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editRating" class="form-label">Calificación</label>
                            <select class="form-select" id="editRating">
                                <option value="5">5 - Excelente</option>
                                <option value="4">4 - Muy Bueno</option>
                                <option value="3">3 - Bueno</option>
                                <option value="2">2 - Regular</option>
                                <option value="1">1 - Malo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notas</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Canvas Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Load environment config FIRST -->
    <script src="../js/env.js?v=20251111"></script>
    <script src="../js/config.js?v=20251111v5"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <!-- PRO Enhancements -->
    <script src="../js/pro-enhancements.js"></script>
    <script src="../js/sidebar-collapsible.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/init.js"></script>
    <script>
        let supplierId;
        let supplierData;
        let quotationsTable;

        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar autenticación
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !Utils.hasPermission(user.role, ['purchaser', 'admin'])) {
                alert('No tienes permisos para acceder a esta página');
                window.location.href = 'dashboard.html';
                return;
            }

            // Obtener ID del proveedor de la URL
            const params = new URLSearchParams(window.location.search);
            supplierId = params.get('id');

            if (!supplierId) {
                Utils.showToast('ID de proveedor no especificado', 'error');
                window.location.href = 'proveedores.html';
                return;
            }

            // Usar la función global de init.js que actualiza el usuario
            await loadComponents();
            await loadSupplierDetails();
            initQuotationsTable();
            setupEventListeners();
        });

        async function loadSupplierDetails() {
            try {
                Utils.showSpinner();

                const data = await api.getSupplierById(supplierId);
                Utils.hideSpinner();

                if (data.success && data.data) {
                    // El backend devuelve los datos del proveedor directamente en data.data
                    supplierData = data.data;
                    displaySupplierInfo(supplierData);
                    displayStatistics(data.data.stats || {});
                } else {
                    Utils.showToast(data.error || 'Error al cargar proveedor', 'error');
                    setTimeout(() => window.location.href = 'proveedores.html', 2000);
                }
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error cargando proveedor:', error);
                Utils.showToast('Error al cargar información del proveedor', 'error');
            }
        }

        function displaySupplierInfo(supplier) {
            // Header
            document.getElementById('supplierName').textContent = supplier.name;
            document.title = `${supplier.name} - Sistema Cielito Home`;

            // Información general
            document.getElementById('detailName').textContent = supplier.name;
            document.getElementById('detailRfc').textContent = supplier.rfc || 'No especificado';
            document.getElementById('detailCategory').textContent = supplier.category || 'Sin categoría';

            // Rating con estrellas
            const ratingDiv = document.getElementById('detailRating');
            const rating = parseFloat(supplier.rating) || 0;
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star text-warning"></i> ';
                } else if (i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt text-warning"></i> ';
                } else {
                    stars += '<i class="far fa-star text-warning"></i> ';
                }
            }
            ratingDiv.innerHTML = stars + `<span class="ms-2">${rating.toFixed(1)}</span>`;

            // Estado
            const statusBadge = document.getElementById('detailStatus');
            if (supplier.is_active) {
                statusBadge.textContent = 'Activo';
                statusBadge.className = 'badge bg-success';
                document.getElementById('toggleActiveText').textContent = 'Desactivar';
            } else {
                statusBadge.textContent = 'Inactivo';
                statusBadge.className = 'badge bg-danger';
                document.getElementById('toggleActiveText').textContent = 'Activar';
            }

            document.getElementById('detailCreatedAt').textContent = Utils.formatDate(supplier.created_at);

            // Datos de contacto
            document.getElementById('detailContactName').textContent = supplier.contact_name || 'No especificado';

            const phoneLink = document.getElementById('detailPhone');
            if (supplier.phone) {
                phoneLink.textContent = supplier.phone;
                phoneLink.href = `tel:${supplier.phone}`;
            } else {
                phoneLink.textContent = 'No especificado';
                phoneLink.removeAttribute('href');
            }

            const emailLink = document.getElementById('detailEmail');
            if (supplier.email) {
                emailLink.textContent = supplier.email;
                emailLink.href = `mailto:${supplier.email}`;
            } else {
                emailLink.textContent = 'No especificado';
                emailLink.removeAttribute('href');
            }

            document.getElementById('detailAddress').textContent = supplier.address || 'No especificada';
            document.getElementById('detailNotes').textContent = supplier.notes || 'Sin notas';
        }

        function displayStatistics(stats) {
            document.getElementById('statQuotations').textContent = stats.total_quotations || 0;
            document.getElementById('statOrders').textContent = stats.total_orders || 0;
            document.getElementById('statTotal').textContent = Utils.formatCurrency(stats.total_purchased || 0);

            const winRate = stats.total_quotations > 0
                ? ((stats.selected_quotations / stats.total_quotations) * 100).toFixed(1)
                : 0;
            document.getElementById('statWinRate').textContent = `${winRate}%`;
        }

        function initQuotationsTable() {
            quotationsTable = $('#quotationsTable').DataTable({
                ...CONFIG.DATATABLE_CONFIG,
                ajax: {
                    url: `${CONFIG.API_URL}/suppliers/${supplierId}/quotations`,
                    type: 'GET',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    dataSrc: json => json.success ? json.data.quotations : []
                },
                columns: [
                    { data: 'request_folio' },
                    {
                        data: 'quoted_at',
                        render: data => Utils.formatDate(data)
                    },
                    {
                        data: 'total_amount',
                        render: data => Utils.formatCurrency(data)
                    },
                    {
                        data: 'delivery_days',
                        render: data => data ? `${data} días` : 'No especificado'
                    },
                    {
                        data: 'has_selected_items',
                        render: data => data === true || data === 1
                            ? '<span class="badge bg-success">Seleccionada</span>'
                            : '<span class="badge bg-secondary">No seleccionada</span>'
                    },
                    {
                        data: null,
                        orderable: false,
                        render: (data, type, row) => `
                            <a href="detalle-solicitud.html?id=${row.request_id}"
                               class="btn btn-sm btn-primary" title="Ver Solicitud">
                                <i class="fas fa-eye"></i>
                            </a>
                        `
                    }
                ],
                order: [[1, 'desc']]
            });
        }

        function setupEventListeners() {
            // Botón editar
            document.getElementById('editSupplierBtn').addEventListener('click', function() {
                openEditModal();
            });

            // Botón activar/desactivar
            document.getElementById('toggleActiveBtn').addEventListener('click', function() {
                toggleSupplierStatus();
            });

            // Formulario de edición
            document.getElementById('editSupplierForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSupplierChanges();
            });
        }

        function openEditModal() {
            // Poblar formulario con datos actuales
            document.getElementById('editName').value = supplierData.name;
            document.getElementById('editRfc').value = supplierData.rfc || '';
            document.getElementById('editContactName').value = supplierData.contact_name || '';
            document.getElementById('editPhone').value = supplierData.phone || '';
            document.getElementById('editEmail').value = supplierData.email || '';
            document.getElementById('editCategory').value = supplierData.category || '';
            document.getElementById('editAddress').value = supplierData.address || '';
            document.getElementById('editRating').value = supplierData.rating || 5;
            document.getElementById('editNotes').value = supplierData.notes || '';

            const modal = new bootstrap.Modal(document.getElementById('editSupplierModal'));
            modal.show();
        }

        async function saveSupplierChanges() {
            try {
                Utils.showSpinner();

                const formData = {
                    name: document.getElementById('editName').value,
                    rfc: document.getElementById('editRfc').value || null,
                    contact_name: document.getElementById('editContactName').value || null,
                    phone: document.getElementById('editPhone').value || null,
                    email: document.getElementById('editEmail').value || null,
                    category: document.getElementById('editCategory').value || null,
                    address: document.getElementById('editAddress').value || null,
                    rating: parseFloat(document.getElementById('editRating').value),
                    notes: document.getElementById('editNotes').value || null
                };

                const response = await fetch(`${CONFIG.API_URL}/suppliers/${supplierId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                Utils.hideSpinner();

                if (response.ok && data.success) {
                    Utils.showToast('Proveedor actualizado exitosamente', 'success');

                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editSupplierModal'));
                    modal.hide();

                    // Recargar datos
                    await loadSupplierDetails();
                } else {
                    Utils.showToast(data.message || 'Error al actualizar proveedor', 'error');
                }
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error actualizando proveedor:', error);
                Utils.showToast('Error al actualizar proveedor', 'error');
            }
        }

        async function toggleSupplierStatus() {
            const action = supplierData.is_active ? 'desactivar' : 'activar';

            if (!confirm(`¿Estás seguro de que deseas ${action} este proveedor?`)) {
                return;
            }

            try {
                Utils.showSpinner();

                const response = await fetch(`${CONFIG.API_URL}/suppliers/${supplierId}/toggle`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                Utils.hideSpinner();

                if (response.ok && data.success) {
                    Utils.showToast(`Proveedor ${action === 'desactivar' ? 'desactivado' : 'activado'} exitosamente`, 'success');
                    await loadSupplierDetails();
                } else {
                    Utils.showToast(data.message || `Error al ${action} proveedor`, 'error');
                }
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error cambiando estado:', error);
                Utils.showToast('Error al cambiar estado del proveedor', 'error');
            }
        }
    </script>
</body>
</html>
