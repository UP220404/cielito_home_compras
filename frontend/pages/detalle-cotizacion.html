<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="../img/cielitohome.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Cotización - Sistema de Compras Cielito Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <link href="../css/ux-improvements.css" rel="stylesheet">
    <link href="../css/pro-enhancements.css" rel="stylesheet">
    <link href="../css/sidebar-collapsible.css" rel="stylesheet">
    <link href="../css/navbar-responsive-fix.css" rel="stylesheet">
    <link href="../css/quick-fixes.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div id="sidebar-container"></div>

            <!-- Main Content -->
            <main class="px-md-4">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <button class="btn btn-light btn-sm mb-2" onclick="history.back()">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <h1 class="page-title">
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                Detalle de Cotizaciones
                            </h1>
                            <p class="mb-0 opacity-75" id="pageSubtitle">Cotizaciones de la solicitud</p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-light purchaser-only" id="compareQuotationsBtn" style="display: none;">
                                <i class="fas fa-balance-scale me-2"></i>
                                Comparar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Content Section -->
                <div class="content-section">

                    <!-- Loading -->
                    <div id="loadingContainer" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="text-muted mt-3">Cargando información de cotizaciones...</p>
                    </div>

                    <!-- Content -->
                    <div id="contentContainer" style="display: none;">

                        <!-- Información de la Solicitud -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    Información de la Solicitud
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3 mb-md-0">
                                            <label class="form-label fw-bold">Folio:</label>
                                            <p id="requestFolio" class="mb-0 text-primary fw-bold">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3 mb-md-0">
                                            <label class="form-label fw-bold">Área:</label>
                                            <p id="requestArea" class="mb-0">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3 mb-md-0">
                                            <label class="form-label fw-bold">Estado:</label>
                                            <div id="requestStatus">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3 mb-md-0">
                                            <label class="form-label fw-bold">Urgencia:</label>
                                            <div id="requestUrgency">-</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="mb-3 mb-md-0">
                                            <label class="form-label fw-bold">Fecha de Entrega:</label>
                                            <p id="requestDeliveryDate" class="mb-0">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Items de la Solicitud -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Items Solicitados
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Material</th>
                                                <th>Especificaciones</th>
                                                <th>Cantidad</th>
                                                <th>Unidad</th>
                                                <th>Costo Aprox.</th>
                                            </tr>
                                        </thead>
                                        <tbody id="requestItemsBody">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                                    Cargando items...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Cotizaciones Recibidas -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>
                                    Cotizaciones Recibidas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="quotationsContainer">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin me-2"></i>
                                        Cargando cotizaciones...
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Canvas Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Load environment config FIRST -->
    <script src="../js/env.js?v=20251111"></script>
    <script src="../js/config.js?v=20251111v5"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <!-- PRO Enhancements -->
    <script src="../js/pro-enhancements.js"></script>
    <script src="../js/sidebar-collapsible.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/init.js"></script>
    <script>
        let requestId;
        let requestData;
        let quotations = [];

        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar autenticación
            if (!Utils.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Obtener ID de la solicitud de la URL
            const params = new URLSearchParams(window.location.search);
            requestId = params.get('id');

            if (!requestId) {
                Utils.showToast('ID de solicitud no especificado', 'error');
                setTimeout(() => window.location.href = 'cotizaciones.html', 2000);
                return;
            }

            // Cargar componentes
            await loadComponents();

            // Cargar datos
            await loadData();
        });

        async function loadData() {
            try {
                // Cargar info de la solicitud
                await loadRequestData();

                // Cargar cotizaciones
                await loadQuotations();

            } catch (error) {
                console.error('Error cargando datos:', error);
                Utils.showToast('Error cargando información', 'error');
            } finally {
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('contentContainer').style.display = 'block';
            }
        }

        async function loadRequestData() {
            try {
                const response = await fetch(`${CONFIG.API_URL}/requests/${requestId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    requestData = data.data; // El backend devuelve la solicitud directamente en data
                    displayRequestInfo(requestData);
                    displayRequestItems(requestData.items || []);

                    // Actualizar subtítulo
                    document.getElementById('pageSubtitle').textContent = `Cotizaciones para ${requestData.folio}`;
                } else {
                    throw new Error(data.message || 'Error cargando solicitud');
                }
            } catch (error) {
                console.error('Error cargando solicitud:', error);
                Utils.showToast('Error cargando información de la solicitud', 'error');
            }
        }

        function displayRequestInfo(request) {
            document.getElementById('requestFolio').textContent = request.folio || '-';
            document.getElementById('requestArea').textContent = request.area || '-';
            document.getElementById('requestStatus').innerHTML = Utils.getStatusBadge(request.status);
            document.getElementById('requestPriority').innerHTML = Utils.getPriorityBadge(request.priority);
            document.getElementById('requestDeliveryDate').textContent = Utils.formatDate(request.delivery_date);
        }

        function displayRequestItems(items) {
            const tbody = document.getElementById('requestItemsBody');

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay items</td></tr>';
                return;
            }

            tbody.innerHTML = items.map(item => `
                <tr>
                    <td class="fw-bold">${item.material}</td>
                    <td>${item.specifications || '-'}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit || 'pza'}</td>
                    <td>${item.approximate_cost ? Utils.formatCurrency(item.approximate_cost) : '-'}</td>
                </tr>
            `).join('');
        }

        async function loadQuotations() {
            try {
                const response = await fetch(`${CONFIG.API_URL}/quotations/request/${requestId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    quotations = data.data.quotations || [];
                    displayQuotations(quotations);

                    // Mostrar botón comparar si hay cotizaciones
                    if (quotations.length > 1) {
                        document.getElementById('compareQuotationsBtn').style.display = 'inline-block';
                        document.getElementById('compareQuotationsBtn').addEventListener('click', function() {
                            window.location.href = `comparacion-cotizaciones.html?request=${requestId}`;
                        });
                    }
                } else {
                    throw new Error(data.message || 'Error cargando cotizaciones');
                }
            } catch (error) {
                console.error('Error cargando cotizaciones:', error);
                Utils.showToast('Error cargando cotizaciones', 'error');
                displayQuotations([]);
            }
        }

        function displayQuotations(quotations) {
            const container = document.getElementById('quotationsContainer');

            if (!quotations || quotations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p class="mb-0">No hay cotizaciones recibidas para esta solicitud</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = quotations.map(q => `
                <div class="card mb-3 ${q.is_selected ? 'border-success' : ''}">
                    <div class="card-header ${q.is_selected ? 'bg-success-subtle' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-building me-2"></i>
                                ${q.supplier_name}
                                ${q.is_selected ? '<span class="badge bg-success ms-2">Seleccionada</span>' : ''}
                            </h6>
                            <span class="text-muted small">
                                <i class="fas fa-calendar me-1"></i>
                                ${Utils.formatDate(q.quoted_at)}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="text-muted small">Número de Cotización</label>
                                <p class="mb-0 fw-bold">${q.quotation_number || 'N/A'}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small">Monto Total</label>
                                <p class="mb-0 fw-bold text-success">${Utils.formatCurrency(q.total_amount)}</p>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small">Días de Entrega</label>
                                <p class="mb-0">${q.delivery_days || 'Inmediata'} días</p>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small">Validez</label>
                                <p class="mb-0">${q.validity_days || 30} días</p>
                            </div>
                        </div>
                        ${q.payment_terms ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <label class="text-muted small">Términos de Pago</label>
                                    <p class="mb-0">${q.payment_terms}</p>
                                </div>
                            </div>
                        ` : ''}
                        ${q.notes ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <label class="text-muted small">Notas</label>
                                    <p class="mb-0">${q.notes}</p>
                                </div>
                            </div>
                        ` : ''}
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="text-muted small">Contacto del Proveedor</label>
                                <p class="mb-0">
                                    ${q.contact_name ? `<i class="fas fa-user me-2"></i>${q.contact_name} - ` : ''}
                                    ${q.supplier_phone ? `<i class="fas fa-phone me-2"></i>${q.supplier_phone}` : ''}
                                    ${q.supplier_email ? ` - <i class="fas fa-envelope me-2"></i>${q.supplier_email}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
