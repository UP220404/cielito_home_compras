<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="../img/cielitohome.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Orden de Compra - Sistema Cielito Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <link href="../css/ux-improvements.css" rel="stylesheet">
    <link href="../css/pro-enhancements.css" rel="stylesheet">
    <link href="../css/sidebar-collapsible.css" rel="stylesheet">
    <link href="../css/navbar-responsive-fix.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>
    <div class="container-fluid">
        <div class="row">
            <div id="sidebar-container"></div>
            <main class="px-md-4">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <button class="btn btn-light btn-sm mb-2" onclick="history.back()">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <h1 class="page-title">
                                <i class="fas fa-receipt me-2"></i>
                                Orden: <span id="orderFolio">Cargando...</span>
                            </h1>
                            <p class="mb-0 opacity-75">Detalle completo de la orden de compra</p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-light" id="downloadPdfBtn" style="display: none;">
                                <i class="fas fa-file-pdf me-2"></i>
                                PDF
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog me-2"></i>
                                    Estado
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="changeStatus('en_transito')">
                                        <i class="fas fa-truck me-2"></i>En Tránsito
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="changeStatus('recibida')">
                                        <i class="fas fa-check-circle me-2"></i>Recibida
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="changeStatus('cancelada')">
                                        <i class="fas fa-times-circle me-2"></i>Cancelar
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información de la Orden -->
                <div class="row mb-4">
                    <!-- Datos Principales -->
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información de la Orden
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small">Folio de Orden</label>
                                        <div class="fw-bold" id="detailFolio">-</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small">Solicitud Relacionada</label>
                                        <div>
                                            <a href="#" id="requestLink" class="text-decoration-none">-</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small">Fecha de Orden</label>
                                        <div id="detailOrderDate">-</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small">Entrega Esperada</label>
                                        <div id="detailExpectedDelivery">-</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small">Entrega Real</label>
                                        <div id="detailActualDelivery">-</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="text-muted small">Creado Por</label>
                                        <div id="detailCreatedBy">-</div>
                                    </div>
                                </div>
                                <div class="mb-0">
                                    <label class="text-muted small">Notas</label>
                                    <div class="text-muted" id="detailNotes">Sin notas</div>
                                </div>
                            </div>
                        </div>

                        <!-- Información de Proveedores -->
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-building me-2"></i>
                                    Proveedores
                                </h5>
                            </div>
                            <div class="card-body" id="suppliersContainer">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Estado
                                </h5>
                            </div>
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="statusBadge">
                                    <span class="badge bg-primary">-</span>
                                </h3>
                                <p class="text-muted mb-0 mt-2" id="statusTimestamp">-</p>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-money-bill-wave me-2"></i>
                                    Resumen Financiero
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Monto Total:</span>
                                    <span class="fw-bold text-success" id="totalAmount">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Término de Pago:</span>
                                    <span id="paymentTerms">-</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Validez:</span>
                                    <span id="validity">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items de la Orden -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Items de la Orden
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Material</th>
                                        <th>Proveedor</th>
                                        <th>Especificaciones</th>
                                        <th>Cantidad</th>
                                        <th>Unidad</th>
                                        <th class="text-end">Precio Unitario</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Cargando items...
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="7" class="text-end fw-bold">Total:</td>
                                        <td class="text-end fw-bold text-success" id="footerTotal">$0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Historial de Cambios -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Historial de Cambios
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline" id="historyTimeline">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Cargando historial...
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Calificación de Proveedores -->
    <div class="modal fade" id="ratingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-star me-2"></i>
                        Calificar Proveedores
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">
                        Ahora que has recibido la orden, por favor califica a los proveedores:
                    </p>
                    <div id="suppliersRatingContainer">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="submitRatingBtn">
                        <i class="fas fa-check me-2"></i>
                        Enviar Calificaciones
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Canvas Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Load environment config FIRST -->
    <script src="../js/env.js?v=20251111"></script>
    <script src="../js/config.js?v=20251111v5"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/init.js"></script>
    <script src="../js/auth.js"></script>
    <!-- PRO Enhancements -->
    <script src="../js/pro-enhancements.js"></script>
    <script src="../js/sidebar-collapsible.js"></script>
    <script>
        let orderId;
        let orderData;

        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar autenticación
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Obtener ID de la orden de la URL
            const params = new URLSearchParams(window.location.search);
            orderId = params.get('id');

            if (!orderId) {
                Utils.showToast('ID de orden no especificado', 'error');
                window.location.href = 'ordenes-compra.html';
                return;
            }

            // Cargar componentes (usa la función global de init.js)
            await loadComponents();
            await loadOrderDetails();
            setupEventListeners();
        });

        async function loadOrderDetails() {
            try {
                Utils.showSpinner();

                const response = await fetch(`${CONFIG.API_URL}/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                const data = await response.json();
                Utils.hideSpinner();

                if (response.ok && data.success) {
                    orderData = data.data;
                    displayOrderInfo(orderData);
                    displayItems(orderData.items || []);
                    displayHistory();
                } else {
                    Utils.showToast(data.error || 'Error al cargar orden', 'error');
                    setTimeout(() => window.location.href = 'ordenes-compra.html', 2000);
                }
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error cargando orden:', error);
                Utils.showToast('Error al cargar información de la orden', 'error');
            }
        }

        function displayOrderInfo(order) {
            // Header
            document.getElementById('orderFolio').textContent = order.folio;
            document.title = `${order.folio} - Sistema Cielito Home`;

            // Información de la orden
            document.getElementById('detailFolio').textContent = order.folio;

            const requestLink = document.getElementById('requestLink');
            requestLink.textContent = order.request_folio;
            requestLink.href = `detalle-solicitud.html?id=${order.request_id}`;

            document.getElementById('detailOrderDate').textContent = Utils.formatDate(order.order_date);
            document.getElementById('detailExpectedDelivery').textContent = order.expected_delivery
                ? Utils.formatDate(order.expected_delivery)
                : 'No especificada';
            document.getElementById('detailActualDelivery').textContent = order.actual_delivery
                ? Utils.formatDate(order.actual_delivery)
                : 'Pendiente';
            document.getElementById('detailCreatedBy').textContent = order.created_by_name || 'Sistema';
            document.getElementById('detailNotes').textContent = order.notes || 'Sin notas';

            // Estado
            const statusColors = {
                emitida: 'primary',
                en_transito: 'info',
                recibida: 'success',
                cancelada: 'danger'
            };
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.innerHTML = `<span class="badge bg-${statusColors[order.status]}">${CONFIG.ESTATUS_ORDERS[order.status] || order.status}</span>`;

            document.getElementById('statusTimestamp').textContent = `Actualizado: ${Utils.formatDate(order.updated_at)}`;

            // Mostrar/ocultar botón PDF según estado
            const pdfBtn = document.getElementById('downloadPdfBtn');
            if (order.status === 'recibida') {
                pdfBtn.style.display = 'inline-block';
            } else {
                pdfBtn.style.display = 'none';
            }

            // Resumen financiero
            document.getElementById('totalAmount').textContent = Utils.formatCurrency(order.total_amount);
            document.getElementById('paymentTerms').textContent = order.payment_terms || 'Ver en cotizaciones';
            document.getElementById('validity').textContent = order.validity_days
                ? `${order.validity_days} días`
                : 'Ver en cotizaciones';
        }

        function displaySuppliers(items) {
            const container = document.getElementById('suppliersContainer');

            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay proveedores</p>';
                return;
            }

            // Agrupar items por proveedor
            const supplierGroups = {};
            items.forEach(item => {
                const supplierName = item.supplier_name || 'Proveedor no especificado';
                if (!supplierGroups[supplierName]) {
                    supplierGroups[supplierName] = {
                        items: [],
                        total: 0
                    };
                }
                supplierGroups[supplierName].items.push(item);
                supplierGroups[supplierName].total += parseFloat(item.subtotal || 0);
            });

            const supplierNames = Object.keys(supplierGroups);

            let html = '';
            supplierNames.forEach((supplierName, index) => {
                const group = supplierGroups[supplierName];
                html += `
                    <div class="${index > 0 ? 'border-top pt-3 mt-3' : ''}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${supplierName}</strong>
                            <span class="badge bg-success">${Utils.formatCurrency(group.total)}</span>
                        </div>
                        <ul class="list-unstyled small text-muted mb-0">
                            ${group.items.map(item => `<li>• ${item.material} (${item.quantity} ${item.unit})</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayItems(items) {
            const tbody = document.getElementById('itemsTableBody');
            const footerTotal = document.getElementById('footerTotal');

            // También mostrar proveedores agrupados
            displaySuppliers(items);

            if (!items || items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">No hay items registrados</td>
                    </tr>
                `;
                footerTotal.textContent = '$0.00';
                return;
            }

            let total = 0;
            tbody.innerHTML = items.map((item, index) => {
                total += parseFloat(item.subtotal || 0);
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="fw-bold">${item.material}</td>
                        <td><small class="text-muted">${item.supplier_name || '-'}</small></td>
                        <td>${item.specifications || '-'}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit || 'pza'}</td>
                        <td class="text-end">${Utils.formatCurrency(item.unit_price)}</td>
                        <td class="text-end">${Utils.formatCurrency(item.subtotal)}</td>
                    </tr>
                `;
            }).join('');

            footerTotal.textContent = Utils.formatCurrency(total);
        }

        async function displayHistory() {
            const timeline = document.getElementById('historyTimeline');

            try {
                // Obtener historial completo desde el backend
                const response = await fetch(`${CONFIG.API_URL}/orders/${orderId}/history`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Error al cargar historial');
                }

                const auditLogs = data.data || [];

                // Mapear cada registro del audit_log a un evento visual
                const history = auditLogs.map(log => {
                    let action = 'Cambio registrado';
                    let icon = 'fa-edit';
                    let color = 'secondary';
                    let details = '';

                    // Determinar el tipo de acción y su presentación
                    if (log.action === 'create') {
                        action = 'Orden creada';
                        icon = 'fa-plus-circle';
                        color = 'primary';
                    } else if (log.action === 'update' && log.new_values) {
                        try {
                            const newValues = typeof log.new_values === 'string'
                                ? JSON.parse(log.new_values)
                                : log.new_values;

                            // Detectar cambio de estado
                            if (newValues.status) {
                                const statusLabels = {
                                    'emitida': 'Emitida',
                                    'en_transito': 'En Tránsito',
                                    'recibida': 'Recibida',
                                    'cancelada': 'Cancelada'
                                };

                                action = `Estado cambiado a: ${statusLabels[newValues.status] || newValues.status}`;

                                // Iconos y colores según el estado
                                if (newValues.status === 'emitida') {
                                    icon = 'fa-file-invoice';
                                    color = 'primary';
                                } else if (newValues.status === 'en_transito') {
                                    icon = 'fa-truck';
                                    color = 'info';
                                } else if (newValues.status === 'recibida') {
                                    icon = 'fa-check-circle';
                                    color = 'success';
                                } else if (newValues.status === 'cancelada') {
                                    icon = 'fa-times-circle';
                                    color = 'danger';
                                }
                            }

                            // Mostrar notas si existen
                            if (newValues.notes) {
                                details = `<div class="mt-1 small text-muted">Notas: ${newValues.notes}</div>`;
                            }

                            // Mostrar fecha de entrega real
                            if (newValues.actual_delivery) {
                                details += `<div class="mt-1 small text-muted">Entrega real: ${Utils.formatDate(newValues.actual_delivery)}</div>`;
                            }
                        } catch (e) {
                            console.error('Error parseando new_values:', e);
                        }
                    } else if (log.action === 'delete') {
                        action = 'Orden eliminada';
                        icon = 'fa-trash';
                        color = 'danger';
                    }

                    return {
                        date: log.created_at,
                        action: action,
                        user: log.user_name || 'Sistema',
                        icon: icon,
                        color: color,
                        details: details
                    };
                });

                // Renderizar timeline
                if (history.length === 0) {
                    timeline.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay cambios registrados
                        </div>
                    `;
                } else {
                    timeline.innerHTML = history.map(event => `
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="timeline-icon bg-${event.color} text-white rounded-circle p-2">
                                        <i class="fas ${event.icon}"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-0">${event.action}</h6>
                                    <small class="text-muted">
                                        ${Utils.formatDate(event.date, 'DD/MM/YYYY HH:mm')} - ${event.user}
                                    </small>
                                    ${event.details}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error cargando historial:', error);
                timeline.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar el historial
                    </div>
                `;
            }
        }

        function setupEventListeners() {
            // Botón descargar PDF
            document.getElementById('downloadPdfBtn').addEventListener('click', async function() {
                try {
                    Utils.showToast('Generando PDF...', 'info');

                    const response = await fetch(`${CONFIG.API_URL}/orders/${orderId}/pdf`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error al generar PDF');
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Orden_${orderData.folio || orderId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    Utils.showToast('PDF descargado exitosamente', 'success');
                } catch (error) {
                    console.error('Error descargando PDF:', error);
                    Utils.showToast('Error al descargar PDF: ' + error.message, 'error');
                }
            });
        }

        let suppliersToRate = [];

        async function changeStatus(newStatus) {
            if (!confirm(`¿Estás seguro de cambiar el estado a "${CONFIG.ESTATUS_ORDERS[newStatus]}"?`)) {
                return;
            }

            try {
                Utils.showSpinner();

                const response = await fetch(`${CONFIG.API_URL}/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                Utils.hideSpinner();

                if (response.ok && data.success) {
                    Utils.showToast('Estado actualizado exitosamente', 'success');
                    await loadOrderDetails();

                    // Si el estado es "recibida", mostrar modal de calificación
                    if (newStatus === 'recibida' && orderData.items && orderData.items.length > 0) {
                        showRatingModal();
                    }
                } else {
                    Utils.showToast(data.message || 'Error al cambiar estado', 'error');
                }
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error cambiando estado:', error);
                Utils.showToast('Error al cambiar estado', 'error');
            }
        }

        function showRatingModal() {
            const container = document.getElementById('suppliersRatingContainer');

            // Obtener proveedores únicos de los items
            const supplierMap = {};
            orderData.items.forEach(item => {
                if (item.supplier_name && !supplierMap[item.supplier_name]) {
                    supplierMap[item.supplier_name] = {
                        name: item.supplier_name,
                        // Necesitamos el supplier_id, lo obtendremos del backend
                        rating: 0
                    };
                }
            });

            suppliersToRate = Object.values(supplierMap);

            if (suppliersToRate.length === 0) {
                Utils.showToast('No hay proveedores para calificar', 'info');
                return;
            }

            // Generar HTML para cada proveedor
            let html = '';
            suppliersToRate.forEach((supplier, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${supplier.name}</h6>
                            <div class="text-center">
                                <div class="star-rating my-2" id="starRating_${index}">
                                    ${[1,2,3,4,5].map(r => `
                                        <i class="far fa-star fa-2x star" data-rating="${r}" data-supplier="${index}"></i>
                                    `).join('')}
                                </div>
                                <p class="text-muted small mb-0" id="ratingText_${index}">Selecciona una calificación</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Configurar event listeners de estrellas
            document.querySelectorAll('.star').forEach(star => {
                star.onclick = function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    const supplierIndex = parseInt(this.getAttribute('data-supplier'));
                    suppliersToRate[supplierIndex].rating = rating;
                    updateStarsForSupplier(supplierIndex, rating);
                };

                star.onmouseover = function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    const supplierIndex = parseInt(this.getAttribute('data-supplier'));
                    updateStarsForSupplier(supplierIndex, rating);
                };

                star.onmouseleave = function() {
                    const supplierIndex = parseInt(this.getAttribute('data-supplier'));
                    updateStarsForSupplier(supplierIndex, suppliersToRate[supplierIndex].rating);
                };
            });

            // Configurar botón de enviar
            document.getElementById('submitRatingBtn').onclick = async function() {
                await submitAllRatings();
            };

            // Mostrar modal
            new bootstrap.Modal(document.getElementById('ratingModal')).show();
        }

        function updateStarsForSupplier(supplierIndex, rating) {
            const ratingTexts = {
                0: 'Selecciona una calificación',
                1: 'Muy insatisfecho',
                2: 'Insatisfecho',
                3: 'Neutral',
                4: 'Satisfecho',
                5: 'Muy satisfecho'
            };

            const ratingTextEl = document.getElementById(`ratingText_${supplierIndex}`);
            if (ratingTextEl) {
                ratingTextEl.textContent = ratingTexts[rating] || 'Selecciona una calificación';
            }

            const stars = document.querySelectorAll(`#starRating_${supplierIndex} .star`);
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
        }

        async function submitAllRatings() {
            // Verificar que todos tienen calificación
            const unrated = suppliersToRate.filter(s => s.rating === 0);
            if (unrated.length > 0) {
                Utils.showToast(`Por favor califica a todos los proveedores (${unrated.length} sin calificar)`, 'warning');
                return;
            }

            try {
                Utils.showSpinner();

                // Enviar calificación para cada proveedor
                let successCount = 0;
                let errorCount = 0;

                for (const supplier of suppliersToRate) {
                    // Encontrar el supplier_id del item
                    const item = orderData.items.find(i => i.supplier_name === supplier.name);
                    if (!item || !item.supplier_id) {
                        console.warn('No se encontró supplier_id para:', supplier.name);
                        errorCount++;
                        continue;
                    }

                    try {
                        const response = await fetch(`${CONFIG.API_URL}/suppliers/${item.supplier_id}/rate`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                rating: supplier.rating,
                                order_id: orderId
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (err) {
                        console.error('Error calificando proveedor:', supplier.name, err);
                        errorCount++;
                    }
                }

                Utils.hideSpinner();

                if (successCount > 0) {
                    Utils.showToast(`¡Gracias por calificar a ${successCount} proveedor(es)!`, 'success');
                }
                if (errorCount > 0) {
                    Utils.showToast(`Error al calificar ${errorCount} proveedor(es)`, 'error');
                }

                bootstrap.Modal.getInstance(document.getElementById('ratingModal')).hide();

            } catch (error) {
                Utils.hideSpinner();
                console.error('Error enviando calificaciones:', error);
                Utils.showToast('Error al enviar calificaciones', 'error');
            }
        }
    </script>

    <style>
        .timeline-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-item:not(:last-child) {
            border-left: 2px solid #dee2e6;
            margin-left: 20px;
            padding-left: 10px;
        }

        .star {
            cursor: pointer;
            color: #ffc107;
            margin: 0 5px;
            transition: all 0.2s ease;
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.fas {
            color: #ffc107;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }

        .star.far {
            color: #ddd;
        }
    </style>
</body>
</html>
