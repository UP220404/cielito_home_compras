<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="../img/cielitohome.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparación de Cotizaciones - Sistema Cielito Home</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <link href="../css/styles.css" rel="stylesheet">
    <link href="../css/ux-improvements.css" rel="stylesheet">
    <link href="../css/pro-enhancements.css" rel="stylesheet">
    <link href="../css/sidebar-collapsible.css" rel="stylesheet">
    <link href="../css/navbar-responsive-fix.css" rel="stylesheet">

    <style>
        /* Tabla estilo Excel */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: white;
        }

        .comparison-table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #5a67d8;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .comparison-table tbody td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
        }

        /* Filas de mejor precio */
        .best-price-row {
            background-color: #d4edda !important;
        }

        /* Filas alternadas por producto */
        .product-group-odd {
            background-color: #ffffff;
        }

        .product-group-even {
            background-color: #f8f9fa;
        }

        /* Hover effect */
        .comparison-table tbody tr:hover {
            background-color: #e3f2fd !important;
            cursor: pointer;
        }

        /* Columna de proveedor */
        .supplier-cell {
            font-weight: 600;
            color: #495057;
        }

        /* Columna de producto */
        .product-cell {
            text-align: left;
            font-weight: 500;
        }

        /* Columna de precio */
        .price-cell {
            font-weight: bold;
            color: #28a745;
            font-size: 1.05em;
        }

        /* Badge de factura */
        .invoice-yes {
            background-color: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .invoice-no {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        /* Comentarios */
        .notes-cell {
            font-style: italic;
            color: #6c757d;
            max-width: 200px;
            text-align: left;
        }

        /* Botón de acción */
        .action-btn {
            padding: 4px 8px;
            font-size: 0.85em;
        }

        /* Tabla responsive */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        /* Botón agregar cotización */
        .add-quote-btn {
            margin-top: 8px;
            font-size: 0.85em;
        }

        /* Info card mejorada */
        .info-summary {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div id="sidebar-container"></div>

            <!-- Main Content -->
            <main class="px-md-4">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h1 class="page-title">
                                <i class="fas fa-chart-line me-2"></i>
                                Comparación de Cotizaciones
                            </h1>
                            <p class="mb-0 opacity-75" id="requestInfoText">Compara precios de diferentes proveedores</p>
                        </div>
                        <div id="configColumnsButton" style="display: none;">
                            <button class="btn btn-outline-primary" onclick="configureAreaColumns()">
                                <i class="fas fa-columns me-2"></i>
                                Configurar Columnas
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Información de la Solicitud -->
                <div class="card mb-4" id="requestInfoCard" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            Solicitud: <span id="requestFolio"></span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Estado:</strong>
                                <span id="requestStatus"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Total de Materiales:</strong>
                                <span id="materialCount"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Comparación -->
                <div class="table-container">
                    <table class="comparison-table" id="comparisonTable">
                        <thead>
                            <tr>
                                <th style="width: 8%;">SELECCIONAR</th>
                                <th style="width: 14%;">DÓNDE</th>
                                <th style="width: 18%;">PRODUCTO</th>
                                <th style="width: 12%;">COSTO</th>
                                <th style="width: 18%;">COMENTARIOS</th>
                                <th style="width: 8%;">FACTURA</th>
                                <th style="width: 10%;">GARANTÍA</th>
                                <th style="width: 12%;">FECHA DE ENTREGA</th>
                                <th style="width: 5%;">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                            <!-- Se llenará dinámicamente con JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Estado de Aprobación -->
                <div id="approvalStatusContainer" style="display: none;" class="mt-4">
                    <div class="alert alert-info text-center" id="approvalStatusAlert">
                        <i class="fas fa-clock me-2"></i>
                        <strong>Enviado a Dirección</strong> - Esperando revisión y aprobación del director
                    </div>
                </div>

                <!-- Botón para Crear Orden (aparece cuando está autorizada y tiene cotización seleccionada) -->
                <div class="text-center mt-4" id="createOrderContainer" style="display: none;">
                    <div class="alert alert-success text-center mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Solicitud Autorizada</strong> - Las cotizaciones han sido seleccionadas
                    </div>
                    <a href="ordenes-compra.html" class="btn btn-primary btn-lg" id="createOrderBtn">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Crear Orden de Compra
                    </a>
                    <p class="text-muted mt-2">
                        <small>Procede a generar la orden de compra con las cotizaciones aprobadas</small>
                    </p>
                </div>

                <!-- Botón Enviar a Aprobación -->
                <div class="text-center mt-4" id="sendToApprovalContainer" style="display: none;">
                    <button class="btn btn-success btn-lg" id="sendToApprovalBtn">
                        <i class="fas fa-paper-plane me-2"></i>
                        Enviar a Aprobación de Director
                    </button>
                    <p class="text-muted mt-2">
                        <small>Al enviar, el director podrá revisar y seleccionar las cotizaciones ganadoras</small>
                    </p>
                </div>

            </main>
        </div>
    </div>

    <!-- Modal para Agregar Cotización -->
    <div class="modal fade" id="addQuotationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Agregar Cotización
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addQuotationForm">
                    <div class="modal-body">
                        <input type="hidden" id="modal_request_id" name="request_id">
                        <input type="hidden" id="modal_material_id" name="material_id">
                        <input type="hidden" id="modal_quantity" name="quantity">

                        <!-- Panel de Propuesta del Solicitante -->
                        <div class="alert alert-info mb-3" id="requesterProposalPanel">
                            <h6 class="alert-heading mb-2">
                                <i class="fas fa-lightbulb me-2"></i>
                                Propuesta del Solicitante
                            </h6>
                            <hr class="my-2">
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <strong><i class="fas fa-box me-1"></i> Material:</strong>
                                    <span id="modal_material_name" class="ms-1"></span>
                                    <span class="text-muted">(<span id="modal_quantity_display"></span>)</span>
                                </div>
                                <div class="col-12 mb-2">
                                    <strong><i class="fas fa-clipboard-list me-1"></i> Especificaciones:</strong>
                                    <div id="modal_specifications" class="mt-1 p-2 bg-white rounded border" style="white-space: pre-wrap; font-size: 0.9em;"></div>
                                </div>
                                <div class="col-12" id="approxCostContainer" style="display: none;">
                                    <strong><i class="fas fa-dollar-sign me-1"></i> Costo investigado por solicitante:</strong>
                                    <span id="modal_approx_cost" class="ms-1 badge bg-warning text-dark fs-6"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="modal_supplier" class="form-label">Proveedor *</label>
                            <div class="input-group">
                                <select class="form-select" id="modal_supplier" name="supplier_id" required>
                                    <option value="">Seleccionar...</option>
                                </select>
                                <button type="button" class="btn btn-outline-success" onclick="openNewSupplierModal()" title="Agregar nuevo proveedor">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modal_unit_price" class="form-label">Precio Unitario *</label>
                                <input type="number" class="form-control" id="modal_unit_price" name="unit_price"
                                       step="0.01" min="0.01" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Subtotal</label>
                                <input type="text" class="form-control" id="modal_subtotal" readonly>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modal_has_invoice" class="form-label">¿Factura?</label>
                                <select class="form-select" id="modal_has_invoice" name="has_invoice">
                                    <option value="1">Sí</option>
                                    <option value="0">No</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modal_delivery_date" class="form-label">Fecha de Entrega</label>
                                <input type="date" class="form-control" id="modal_delivery_date" name="delivery_date">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="modal_payment_terms" class="form-label">Método de Pago *</label>
                            <select class="form-select" id="modal_payment_terms" name="payment_terms" required>
                                <option value="">Seleccionar...</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Débito">Débito</option>
                                <option value="Crédito">Crédito</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                        </div>

                        <!-- Sección de Garantía -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modal_has_warranty" class="form-label">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    ¿Tiene Garantía?
                                </label>
                                <select class="form-select" id="modal_has_warranty" name="has_warranty">
                                    <option value="0">No</option>
                                    <option value="1">Sí</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modal_warranty_duration" class="form-label">Duración (meses)</label>
                                <input type="number" class="form-control" id="modal_warranty_duration"
                                       name="warranty_duration" min="0" placeholder="Ej: 12, 24, 36">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="modal_warranty_description" class="form-label">Descripción de Garantía</label>
                            <textarea class="form-control" id="modal_warranty_description" name="garantia"
                                      rows="2" placeholder="Describa qué cubre la garantía (opcional)"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="modal_notes" class="form-label">Comentarios / Notas</label>
                            <textarea class="form-control" id="modal_notes" name="notes" rows="3"></textarea>
                        </div>

                        <!-- Contenedor para columnas dinámicas del área -->
                        <div id="dynamicColumnsContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Guardar Cotización
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Nuevo Proveedor -->
    <div class="modal fade" id="newSupplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-building me-2"></i>
                        Nuevo Proveedor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="newSupplierForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="new_supplier_name" class="form-label">Nombre del Proveedor *</label>
                            <input type="text" class="form-control" id="new_supplier_name" name="name" required
                                   placeholder="Ej: Google, Microsoft, Proveedor XYZ">
                        </div>

                        <div class="mb-3">
                            <label for="new_supplier_category" class="form-label">Categoría</label>
                            <select class="form-select" id="new_supplier_category" name="category">
                                <option value="">Sin categoría</option>
                                <option value="Cursos y Capacitación">Cursos y Capacitación</option>
                                <option value="Servicios en Línea">Servicios en Línea</option>
                                <option value="Software">Software</option>
                                <option value="Papelería">Papelería</option>
                                <option value="Ferretería">Ferretería</option>
                                <option value="Electrónica">Electrónica</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Mobiliario">Mobiliario</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="new_supplier_contact" class="form-label">Contacto</label>
                                <input type="text" class="form-control" id="new_supplier_contact" name="contact_name"
                                       placeholder="Nombre del contacto">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_supplier_phone" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="new_supplier_phone" name="phone"
                                       placeholder="Teléfono">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="new_supplier_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="new_supplier_email" name="email"
                                   placeholder="email@ejemplo.com">
                        </div>

                        <div class="mb-3">
                            <label for="new_supplier_notes" class="form-label">Notas</label>
                            <textarea class="form-control" id="new_supplier_notes" name="notes" rows="2"
                                      placeholder="Notas adicionales sobre el proveedor"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>
                            Crear Proveedor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Canvas Confetti for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Socket.IO Client for real-time notifications -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Load environment config FIRST -->
    <script src="../js/env.js?v=20251111"></script>
    <script src="../js/config.js?v=20251111v5"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/init.js"></script>
    <script src="../js/auth.js"></script>
    <!-- PRO Enhancements -->
    <script src="../js/pro-enhancements.js"></script>
    <script src="../js/sidebar-collapsible.js"></script>
    <script src="../js/area-column-config.js"></script>
    <script>
        let currentRequestId = null;
        let comparisonData = null;
        let suppliers = [];

        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar permisos
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !Utils.hasPermission(user.role, ['purchaser', 'director', 'admin'])) {
                Utils.showToast('No tienes permisos para acceder a esta página', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
                return;
            }

            // Cargar componentes
            await loadComponents();

            // Obtener ID de solicitud de URL
            const params = Utils.getUrlParams();
            currentRequestId = params.request;

            if (!currentRequestId) {
                Utils.showToast('No se especificó una solicitud', 'warning');
                setTimeout(() => window.location.href = 'compras-panel.html', 1500);
                return;
            }

            await loadSuppliers();
            await loadComparisonData();
            setupEventListeners();
        });

        async function loadSuppliers() {
            try {
                // Cargar TODOS los proveedores activos
                const response = await api.getSuppliers(1, 1000, { active_only: 'true' });
                if (response.success) {
                    suppliers = response.data.suppliers;
                    const select = $('#modal_supplier');
                    select.html('<option value="">Seleccionar proveedor...</option>');
                    suppliers.forEach(supplier => {
                        select.append(`<option value="${supplier.id}">${supplier.name}${supplier.category ? ` (${supplier.category})` : ''}</option>`);
                    });

                    // Inicializar Select2 con búsqueda
                    select.select2({
                        theme: 'bootstrap-5',
                        placeholder: 'Buscar proveedor...',
                        allowClear: true,
                        dropdownParent: $('#addQuotationModal'),
                        width: '100%',
                        language: {
                            noResults: function() {
                                return "No se encontraron proveedores";
                            },
                            searching: function() {
                                return "Buscando...";
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error cargando proveedores:', error);
            }
        }

        async function loadComparisonData() {
            try {
                Utils.showSpinner();
                const response = await fetch(`${CONFIG.API_URL}/quotations/request/${currentRequestId}/comparison`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                Utils.hideSpinner();

                if (result.success) {
                    comparisonData = result.data;

                    // Cargar configuración de columnas para el área
                    if (comparisonData.area) {
                        await areaColumnConfig.loadConfig(comparisonData.area);
                        // Mostrar botón de configuración solo para purchaser/admin
                        const user = JSON.parse(localStorage.getItem('user'));
                        if (Utils.hasPermission(user.role, ['purchaser', 'admin'])) {
                            document.getElementById('configColumnsButton').style.display = 'block';
                        }
                    }

                    displayComparisonTable();
                } else {
                    Utils.showToast('Error cargando datos de comparación', 'error');
                }
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error:', error);
                Utils.showToast('Error cargando datos de comparación', 'error');
            }
        }

        // Función para configurar columnas del área
        function configureAreaColumns() {
            if (comparisonData && comparisonData.area) {
                const currentColumns = areaColumnConfig.getEnabledColumns();
                areaColumnConfig.showConfigModal(comparisonData.area, currentColumns);

                // Recargar tabla cuando cambien las columnas
                areaColumnConfig.onColumnsChanged = () => {
                    displayComparisonTable();
                };
            }
        }

        function displayComparisonTable() {
            // Actualizar info de solicitud
            document.getElementById('requestFolio').textContent = comparisonData.request_folio;
            document.getElementById('requestStatus').innerHTML = Utils.getStatusBadge(comparisonData.request_status);
            document.getElementById('materialCount').textContent = comparisonData.materials.length;
            document.getElementById('requestInfoCard').style.display = 'block';
            document.getElementById('requestInfoText').textContent = `Solicitud ${comparisonData.request_folio}`;

            // Actualizar encabezados de tabla con columnas dinámicas
            const enabledColumns = areaColumnConfig.getEnabledColumnsInfo();
            const thead = document.querySelector('#comparisonTable thead tr');

            // Encabezados base
            let headerHTML = `
                <th style="width: 8%;">SELECCIONAR</th>
                <th style="width: 14%;">DÓNDE</th>
                <th style="width: 18%;">PRODUCTO</th>
                <th style="width: 12%;">COSTO</th>
                <th style="width: 18%;">COMENTARIOS</th>
                <th style="width: 8%;">FACTURA</th>
                <th style="width: 10%;">GARANTÍA</th>
                <th style="width: 12%;">FECHA DE ENTREGA</th>
            `;

            // Agregar columnas opcionales
            enabledColumns.forEach(col => {
                headerHTML += `<th>${col.header}</th>`;
            });

            headerHTML += `<th style="width: 5%;">ACCIONES</th>`;
            thead.innerHTML = headerHTML;

            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';

            // Agrupar cotizaciones por producto y generar filas
            comparisonData.materials.forEach((material, index) => {
                const isEvenGroup = index % 2 === 0;
                const groupClass = isEvenGroup ? 'product-group-even' : 'product-group-odd';

                if (material.quotations.length === 0) {
                    // Si no hay cotizaciones, mostrar fila vacía
                    const row = createTableRow({
                        supplier: 'Sin cotizaciones',
                        product: `${material.material} (${material.quantity} ${material.unit})`,
                        cost: '-',
                        comments: 'No hay cotizaciones aún',
                        invoice: '-',
                        warranty: '-',
                        deliveryDate: '-',
                        materialId: material.material_id,
                        materialName: material.material,
                        quantity: material.quantity,
                        quotationItemId: null,
                        groupClass: groupClass,
                        isBestPrice: false,
                        isSelected: false,
                        quotationData: null
                    });
                    tbody.appendChild(row);
                } else {
                    // Encontrar el precio más bajo para este material
                    const lowestPrice = Math.min(...material.quotations.map(q => parseFloat(q.unit_price)));

                    // Verificar si algún ítem tiene is_selected marcado
                    const hasSelectedItem = material.quotations.some(q => q.is_selected === true || q.is_selected === 1);

                    material.quotations.forEach((quotation, qIndex) => {
                        const isLowestPrice = parseFloat(quotation.unit_price) === lowestPrice;
                        const subtotal = quotation.unit_price * material.quantity;

                        // Formatear información de garantía
                        let warrantyText = '-';
                        if (quotation.has_warranty) {
                            if (quotation.warranty_duration) {
                                warrantyText = `<span class="badge bg-info" title="${quotation.garantia || 'Sin descripción'}"><i class="fas fa-shield-alt me-1"></i>${quotation.warranty_duration} meses</span>`;
                            } else {
                                warrantyText = `<span class="badge bg-info" title="${quotation.garantia || 'Sin descripción'}"><i class="fas fa-shield-alt"></i> Sí</span>`;
                            }
                        } else {
                            warrantyText = '<span class="badge bg-secondary">No</span>';
                        }

                        const row = createTableRow({
                            supplier: quotation.supplier_name,
                            product: `${material.material} (${material.quantity} ${material.unit})`,
                            cost: Utils.formatCurrency(subtotal),
                            comments: quotation.notes || '-',
                            invoice: quotation.has_invoice ? 'Sí' : 'No',
                            warranty: warrantyText,
                            deliveryDate: quotation.delivery_date ? Utils.formatDate(quotation.delivery_date) : 'Entrega inmediata',
                            materialId: material.material_id,
                            materialName: material.material,
                            quantity: material.quantity,
                            quotationItemId: quotation.quotation_item_id,
                            groupClass: groupClass,
                            isBestPrice: isLowestPrice,
                            isSelected: quotation.is_selected === true || quotation.is_selected === 1,
                            quotationData: quotation
                        });
                        tbody.appendChild(row);
                    });
                }

                // Agregar fila de "Agregar cotización" para cada material
                const addRow = createAddQuotationRow(material.material_id, material.material, material.quantity);
                tbody.appendChild(addRow);
            });
        }

        function createTableRow(params) {
            const {
                supplier, product, cost, comments, invoice, warranty, deliveryDate,
                materialId, materialName, quantity, quotationItemId,
                groupClass, isBestPrice, isSelected, quotationData
            } = params;

            const row = document.createElement('tr');
            row.className = groupClass;
            if (isBestPrice) {
                row.classList.add('best-price-row');
            }

            // Columnas base
            let cellsHTML = `
                <td class="text-center">
                    ${quotationItemId ? `
                        <input type="radio"
                               name="item_${materialId}"
                               value="${quotationItemId}"
                               data-material-id="${materialId}"
                               ${isSelected ? 'checked' : ''}
                               class="form-check-input item-selector">
                    ` : ''}
                </td>
                <td class="supplier-cell">${supplier}</td>
                <td class="product-cell">${product}</td>
                <td class="price-cell">${cost}</td>
                <td class="notes-cell">${comments}</td>
                <td>
                    <span class="${invoice === 'Sí' ? 'invoice-yes' : 'invoice-no'}">
                        ${invoice}
                    </span>
                </td>
                <td class="text-center">${warranty}</td>
                <td>${deliveryDate}</td>
            `;

            // Agregar columnas opcionales
            const enabledColumns = areaColumnConfig.getEnabledColumnsInfo();
            enabledColumns.forEach(col => {
                const value = quotationData && quotationData[col.id] ? quotationData[col.id] : '-';
                cellsHTML += `<td>${value}</td>`;
            });

            // Columna de acciones
            cellsHTML += `
                <td>
                    ${quotationItemId ? `
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteQuotationItem(${quotationItemId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </td>
            `;

            row.innerHTML = cellsHTML;
            return row;
        }

        function createAddQuotationRow(materialId, materialName, quantity) {
            const row = document.createElement('tr');
            row.style.backgroundColor = '#e7f3ff';
            row.style.borderTop = '2px dashed #0d6efd';

            // Calcular colspan: 7 columnas base + columnas opcionales + 1 acciones
            const enabledColumns = areaColumnConfig.getEnabledColumnsInfo();
            const totalColumns = 8 + enabledColumns.length;

            row.innerHTML = `
                <td colspan="${totalColumns}" class="text-center">
                    <button class="btn btn-sm btn-primary add-quote-btn" onclick="openAddQuotationModal(${materialId}, '${materialName.replace(/'/g, "\\'")}', ${quantity})">
                        <i class="fas fa-plus me-1"></i>
                        Agregar cotización para este producto
                    </button>
                </td>
            `;

            return row;
        }

        function openAddQuotationModal(materialId, materialName, quantity) {
            // Resetear form
            document.getElementById('addQuotationForm').reset();

            // Establecer valores básicos
            document.getElementById('modal_request_id').value = currentRequestId;
            document.getElementById('modal_material_id').value = materialId;
            document.getElementById('modal_quantity').value = quantity;

            // Buscar el material en comparisonData para obtener toda la info del solicitante
            const materialData = comparisonData.materials.find(m => m.material_id === materialId);

            // Poblar panel de propuesta del solicitante
            document.getElementById('modal_material_name').textContent = materialName;
            document.getElementById('modal_quantity_display').textContent = `${quantity} ${materialData?.unit || 'pza'}`;
            document.getElementById('modal_specifications').textContent = materialData?.specifications || 'Sin especificaciones';

            // Mostrar costo aproximado si existe
            const approxCostContainer = document.getElementById('approxCostContainer');
            const approxCostEl = document.getElementById('modal_approx_cost');
            if (materialData?.approximate_cost && materialData.approximate_cost > 0) {
                approxCostEl.textContent = Utils.formatCurrency(materialData.approximate_cost);
                approxCostContainer.style.display = 'block';
            } else {
                approxCostContainer.style.display = 'none';
            }

            // Cargar columnas dinámicas del área
            const dynamicContainer = document.getElementById('dynamicColumnsContainer');
            dynamicContainer.innerHTML = ''; // Limpiar columnas anteriores

            if (comparisonData && comparisonData.area && areaColumnConfig) {
                const enabledColumns = areaColumnConfig.getEnabledColumnsInfo();

                if (enabledColumns && enabledColumns.length > 0) {
                    // Agregar título para las columnas dinámicas
                    const title = document.createElement('hr');
                    dynamicContainer.appendChild(title);

                    const titleText = document.createElement('h6');
                    titleText.className = 'text-muted mb-3';
                    titleText.innerHTML = '<i class="fas fa-cog me-2"></i>Campos Adicionales del Área';
                    dynamicContainer.appendChild(titleText);

                    // Generar campos dinámicos
                    enabledColumns.forEach(column => {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'mb-3';

                        const label = document.createElement('label');
                        label.className = 'form-label';
                        label.textContent = column.header;
                        label.setAttribute('for', `modal_${column.id}`);

                        let input;
                        if (column.type === 'text' || !column.type) {
                            input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'form-control';
                        } else if (column.type === 'textarea') {
                            input = document.createElement('textarea');
                            input.className = 'form-control';
                            input.rows = 2;
                        } else if (column.type === 'number') {
                            input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'form-control';
                            input.step = '0.01';
                        } else if (column.type === 'date') {
                            input = document.createElement('input');
                            input.type = 'date';
                            input.className = 'form-control';
                        }

                        input.id = `modal_${column.id}`;
                        input.name = column.id;

                        fieldDiv.appendChild(label);
                        fieldDiv.appendChild(input);
                        dynamicContainer.appendChild(fieldDiv);
                    });
                }
            }

            new bootstrap.Modal(document.getElementById('addQuotationModal')).show();
        }

        // Funciones para el modal de nuevo proveedor
        function openNewSupplierModal() {
            document.getElementById('newSupplierForm').reset();
            new bootstrap.Modal(document.getElementById('newSupplierModal')).show();
        }

        async function createNewSupplier(e) {
            e.preventDefault();

            try {
                const formData = new FormData(document.getElementById('newSupplierForm'));

                const supplierData = {
                    name: formData.get('name'),
                    category: formData.get('category') || null,
                    contact_name: formData.get('contact_name') || null,
                    phone: formData.get('phone') || null,
                    email: formData.get('email') || null,
                    notes: formData.get('notes') || null
                };

                console.log('Creando proveedor:', supplierData);

                const response = await api.createSupplier(supplierData);

                if (response.success) {
                    Utils.showToast('Proveedor creado exitosamente', 'success');

                    // Cerrar modal de nuevo proveedor
                    bootstrap.Modal.getInstance(document.getElementById('newSupplierModal')).hide();

                    // Recargar la lista de proveedores
                    await loadSuppliers();

                    // Seleccionar el nuevo proveedor en el select
                    const newSupplierId = response.data.id;
                    if (newSupplierId) {
                        document.getElementById('modal_supplier').value = newSupplierId;
                    }
                } else {
                    Utils.showToast(response.message || 'Error al crear proveedor', 'error');
                }
            } catch (error) {
                console.error('Error creando proveedor:', error);
                Utils.showToast('Error al crear el proveedor', 'error');
            }
        }

        async function loadSuppliers() {
            try {
                // Cargar TODOS los proveedores activos
                const response = await api.getSuppliers(1, 1000, { active_only: 'true' });

                if (response.success && response.data) {
                    suppliers = response.data.suppliers || response.data || [];

                    // Actualizar el select de proveedores
                    const select = document.getElementById('modal_supplier');
                    const currentValue = select.value; // Guardar valor actual

                    select.innerHTML = '<option value="">Seleccionar...</option>';
                    suppliers.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.id;
                        option.textContent = supplier.name + (supplier.category ? ` (${supplier.category})` : '');
                        select.appendChild(option);
                    });

                    // Restaurar valor si existía
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error cargando proveedores:', error);
            }
        }

        function setupEventListeners() {
            // Calcular subtotal automáticamente
            document.getElementById('modal_unit_price').addEventListener('input', function() {
                const unitPrice = parseFloat(this.value) || 0;
                const quantity = parseFloat(document.getElementById('modal_quantity').value) || 0;
                const subtotal = unitPrice * quantity;
                document.getElementById('modal_subtotal').value = Utils.formatCurrency(subtotal);
            });

            // Submit form de cotización
            document.getElementById('addQuotationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveQuotation();
            });

            // Submit form de nuevo proveedor
            document.getElementById('newSupplierForm').addEventListener('submit', createNewSupplier);

            // Enviar a aprobación
            document.getElementById('sendToApprovalBtn').addEventListener('click', sendToApproval);
        }

        async function saveQuotation() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addQuotationModal'));
            const submitBtn = document.querySelector('#addQuotationForm button[type="submit"]');

            try {
                // Deshabilitar botón y mostrar loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

                const formData = new FormData(document.getElementById('addQuotationForm'));
                const quantity = parseInt(formData.get('quantity'));
                const unitPrice = parseFloat(formData.get('unit_price'));
                const subtotal = quantity * unitPrice;

                // Validar que subtotal sea válido
                if (!subtotal || subtotal <= 0 || isNaN(subtotal)) {
                    Utils.showToast('El precio unitario debe ser mayor a 0', 'error');
                    return;
                }

                // Crear objeto base del item
                const itemData = {
                    request_item_id: parseInt(formData.get('material_id')),
                    quantity: quantity,
                    unit_price: parseFloat(unitPrice.toFixed(2)),
                    has_invoice: parseInt(formData.get('has_invoice')),
                    delivery_date: formData.get('delivery_date') || undefined,
                    notes: formData.get('notes') || undefined,
                    // Campos de garantía
                    has_warranty: parseInt(formData.get('has_warranty')) || 0,
                    warranty_duration: formData.get('warranty_duration') ? parseInt(formData.get('warranty_duration')) : undefined,
                    garantia: formData.get('garantia') || undefined
                };

                // Agregar campos dinámicos del área
                if (comparisonData && comparisonData.area && areaColumnConfig) {
                    const enabledColumns = areaColumnConfig.getEnabledColumnsInfo();

                    if (enabledColumns && enabledColumns.length > 0) {
                        enabledColumns.forEach(column => {
                            const value = formData.get(column.id);
                            if (value !== null && value !== '') {
                                itemData[column.id] = value;
                            }
                        });
                    }
                }

                // Crear la cotización
                const quotationData = {
                    request_id: parseInt(formData.get('request_id')),
                    supplier_id: parseInt(formData.get('supplier_id')),
                    quotation_number: `COT-${Date.now()}`,
                    total_amount: parseFloat(subtotal.toFixed(2)),
                    payment_terms: formData.get('payment_terms'),
                    items: [itemData]
                };

                console.log('Enviando datos:', quotationData);
                const response = await api.createQuotation(quotationData);

                if (response.success) {
                    Utils.showToast('✅ Cotización agregada exitosamente', 'success');
                    modal.hide();
                    await loadComparisonData();
                } else {
                    Utils.showToast(response.message || 'Error al guardar cotización', 'error');
                }
            } catch (error) {
                console.error('Error completo:', error);
                console.error('Detalles:', error.details || error.message);
                Utils.handleApiError(error, 'Error guardando cotización');
            } finally {
                // Restaurar botón
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cotización';
            }
        }

        async function deleteQuotationItem(itemId) {
            Utils.showConfirm('Eliminar Cotización', '¿Estás seguro de eliminar esta cotización?', async () => {
                try {
                    const response = await api.deleteQuotationItem(itemId);

                    if (response.success) {
                        Utils.showToast('Cotización eliminada exitosamente', 'success');
                        await loadComparisonData();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    Utils.handleApiError(error, 'Error eliminando cotización');
                }
            });
        }


        // Llamar después de cargar datos
        async function loadComparisonData() {
            try {
                Utils.showSpinner();
                const response = await fetch(`${CONFIG.API_URL}/quotations/request/${currentRequestId}/comparison`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                Utils.hideSpinner();

                if (result.success) {
                    comparisonData = result.data;
                    displayComparisonTable();
                    checkSendToApprovalButton();
                } else {
                    Utils.showToast('Error cargando datos de comparación', 'error');
                }
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error:', error);
                Utils.showToast('Error cargando datos de comparación', 'error');
            }
        }

        // Verificar si mostrar botón de enviar a aprobación o crear orden
        function checkSendToApprovalButton() {
            const container = document.getElementById('sendToApprovalContainer');
            const statusContainer = document.getElementById('approvalStatusContainer');
            const createOrderContainer = document.getElementById('createOrderContainer');
            const hasQuotations = comparisonData && comparisonData.materials &&
                                  comparisonData.materials.some(m => m.quotations && m.quotations.length > 0);

            // Verificar si tiene items seleccionados (cotización aprobada)
            const hasSelectedItems = comparisonData && comparisonData.materials &&
                                     comparisonData.materials.some(m => m.quotations &&
                                     m.quotations.some(q => q.is_selected === true || q.is_selected === 1));

            // Verificar si la solicitud está autorizada
            const isAuthorized = comparisonData && comparisonData.request &&
                                comparisonData.request.status === 'autorizada';

            // Verificar si ya se envió a aprobación
            const alreadySent = localStorage.getItem(`approval_sent_${currentRequestId}`) === 'true';

            if (isAuthorized && hasSelectedItems) {
                // Solicitud autorizada con cotizaciones seleccionadas -> mostrar botón de crear orden
                container.style.display = 'none';
                statusContainer.style.display = 'none';
                createOrderContainer.style.display = 'block';
            } else if (alreadySent) {
                // Ya se envió a aprobación, esperando director
                container.style.display = 'none';
                statusContainer.style.display = 'block';
                createOrderContainer.style.display = 'none';
            } else if (hasQuotations) {
                // Tiene cotizaciones pero no se ha enviado
                container.style.display = 'block';
                statusContainer.style.display = 'none';
                createOrderContainer.style.display = 'none';
            } else {
                // No tiene cotizaciones
                container.style.display = 'none';
                statusContainer.style.display = 'none';
                createOrderContainer.style.display = 'none';
            }
        }

        // Enviar solicitud a aprobación del director
        async function sendToApproval() {
            try {
                // Verificar que todos los materiales tengan al menos una cotización
                const materialsWithoutQuotations = comparisonData.materials.filter(
                    m => !m.quotations || m.quotations.length === 0
                );

                if (materialsWithoutQuotations.length > 0) {
                    const materialNames = materialsWithoutQuotations.map(m => m.material).join(', ');
                    Utils.showToast(`Faltan cotizaciones para: ${materialNames}`, 'warning');
                    return;
                }

                Utils.showConfirm(
                    'Enviar para Aprobación',
                    '¿Enviar las cotizaciones para aprobación del director? El director podrá revisar y seleccionar las mejores opciones.',
                    async () => {
                        try {
                            Utils.showSpinner();

                            // Notificar a los directores
                            const response = await fetch(`${CONFIG.API_URL}/notifications/notify-approval`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                },
                                body: JSON.stringify({
                                    request_id: currentRequestId
                                })
                            });

                            const result = await response.json();
                            Utils.hideSpinner();

                            if (response.ok && result.success) {
                                Utils.showToast('Cotizaciones enviadas a aprobación del director', 'success');
                                // Mostrar estado de enviado y ocultar botón
                                document.getElementById('sendToApprovalContainer').style.display = 'none';
                                document.getElementById('approvalStatusContainer').style.display = 'block';
                                // Guardar en localStorage que ya se envió
                                localStorage.setItem(`approval_sent_${currentRequestId}`, 'true');
                            } else {
                                Utils.showToast(result.message || 'Error al enviar a aprobación', 'error');
                            }
                        } catch (error) {
                            Utils.hideSpinner();
                            console.error('Error:', error);
                            Utils.showToast('Error al enviar a aprobación', 'error');
                        }
                    }
                );
            } catch (error) {
                Utils.hideSpinner();
                console.error('Error:', error);
                Utils.showToast('Error al enviar a aprobación', 'error');
            }
        }
    </script>
</body>
</html>
