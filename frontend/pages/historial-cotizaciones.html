<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="../img/cielitohome.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Cotizaciones - Sistema de Compras Cielito Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div id="sidebar-container"></div>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="container-fluid py-4">
                    <!-- Encabezado -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-history me-2"></i>Historial de Cotizaciones</h2>
                            <p class="text-muted mb-0">Consulta cotizaciones completadas y sus detalles</p>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label small">Estado de Solicitud</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Todos</option>
                                        <option value="autorizada">Autorizadas</option>
                                        <option value="emitida">Emitidas</option>
                                        <option value="recibida">Recibidas</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Proveedor</label>
                                    <select class="form-select" id="supplierFilter">
                                        <option value="">Todos</option>
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Mes</label>
                                    <select class="form-select" id="monthFilter">
                                        <option value="">Todos</option>
                                        <option value="01">Enero</option>
                                        <option value="02">Febrero</option>
                                        <option value="03">Marzo</option>
                                        <option value="04">Abril</option>
                                        <option value="05">Mayo</option>
                                        <option value="06">Junio</option>
                                        <option value="07">Julio</option>
                                        <option value="08">Agosto</option>
                                        <option value="09">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Año</label>
                                    <select class="form-select" id="yearFilter">
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" onclick="loadQuotations()">
                                        <i class="fas fa-search me-2"></i>Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Cotizaciones -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                Cotizaciones Completadas
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="quotationsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Folio Solicitud</th>
                                            <th>Área</th>
                                            <th>Proveedor</th>
                                            <th>Material</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unit.</th>
                                            <th>Subtotal</th>
                                            <th>Método Pago</th>
                                            <th>Fecha Entrega</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="quotationsTableBody">
                                        <tr>
                                            <td colspan="11" class="text-center text-muted py-5">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>Cargando cotizaciones...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Ver Detalle -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        Detalle de Cotización
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <!-- Load environment config FIRST -->
    <script src="../js/env.js?v=20251111"></script>
    <script src="../js/config.js?v=20251111v5"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/init.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Cargar componentes
            await loadComponents();

            currentUser = Utils.getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Solo purchaser, director y admin pueden ver esta página
            if (!['purchaser', 'director', 'admin'].includes(currentUser.role)) {
                Utils.showToast('No tienes permiso para ver esta página', 'error');
                window.location.href = 'dashboard.html';
                return;
            }

            // Inicializar filtros
            initializeFilters();

            // Cargar proveedores para el filtro
            loadSuppliers();

            // Cargar cotizaciones
            loadQuotations();
        });

        function initializeFilters() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();

            // Generar años
            for (let year = currentYear - 3; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        async function loadSuppliers() {
            try {
                const response = await fetch(`${CONFIG.API_URL}/suppliers`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('supplierFilter');
                    data.data.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.id;
                        option.textContent = supplier.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando proveedores:', error);
            }
        }

        async function loadQuotations() {
            try {
                const status = document.getElementById('statusFilter').value;
                const supplier = document.getElementById('supplierFilter').value;
                const month = document.getElementById('monthFilter').value;
                const year = document.getElementById('yearFilter').value;

                let url = `${CONFIG.API_URL}/quotations/history?`;
                if (status) url += `status=${status}&`;
                if (supplier) url += `supplier_id=${supplier}&`;
                if (month) url += `month=${month}&`;
                if (year) url += `year=${year}&`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                if (data.success) {
                    renderQuotations(data.data);
                } else {
                    Utils.showToast(data.error || 'Error cargando cotizaciones', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Utils.showToast('Error al cargar cotizaciones', 'error');
            }
        }

        function renderQuotations(quotations) {
            const tbody = document.getElementById('quotationsTableBody');

            if (!quotations || quotations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No se encontraron cotizaciones</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const statusColors = {
                'autorizada': 'success',
                'emitida': 'warning',
                'recibida': 'info',
                'en_transito': 'primary'
            };

            tbody.innerHTML = quotations.map(q => `
                <tr>
                    <td>
                        <a href="detalle-solicitud.html?id=${q.request_id}" class="text-decoration-none">
                            ${q.request_folio}
                        </a>
                    </td>
                    <td><span class="badge bg-secondary">${q.area}</span></td>
                    <td>${q.supplier_name}</td>
                    <td>${q.material}</td>
                    <td>${q.quantity} ${q.unit || 'pza'}</td>
                    <td class="text-end">${Utils.formatCurrency(q.unit_price)}</td>
                    <td class="text-end fw-bold">${Utils.formatCurrency(q.subtotal)}</td>
                    <td>
                        ${q.payment_terms ?
                            `<span class="badge bg-info">${q.payment_terms}</span>` :
                            '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>${q.delivery_date ? Utils.formatDate(q.delivery_date) : 'Inmediata'}</td>
                    <td>
                        <span class="badge bg-${statusColors[q.request_status] || 'secondary'}">
                            ${q.request_status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="viewDetail(${q.quotation_item_id})"
                            title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function viewDetail(itemId) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/quotations/item/${itemId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                if (data.success) {
                    const item = data.data;

                    document.getElementById('detailContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Solicitud</label>
                                <p class="mb-0">${item.request_folio}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Área</label>
                                <p class="mb-0">${item.area}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Proveedor</label>
                                <p class="mb-0">${item.supplier_name}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Material</label>
                                <p class="mb-0">${item.material}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Cantidad</label>
                                <p class="mb-0">${item.quantity} ${item.unit || 'pza'}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Especificaciones</label>
                                <p class="mb-0">${item.specifications || '-'}</p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-muted">Precio Unitario</label>
                                <p class="mb-0">${Utils.formatCurrency(item.unit_price)}</p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-muted">Subtotal</label>
                                <p class="mb-0 text-success fw-bold">${Utils.formatCurrency(item.subtotal)}</p>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-muted">¿Factura?</label>
                                <p class="mb-0">${item.has_invoice ? 'Sí' : 'No'}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Método de Pago</label>
                                <p class="mb-0">
                                    ${item.payment_terms ?
                                        `<span class="badge bg-info fs-6">${item.payment_terms}</span>` :
                                        '<span class="text-muted">No especificado</span>'
                                    }
                                </p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Fecha de Entrega</label>
                                <p class="mb-0">${item.delivery_date ? Utils.formatDate(item.delivery_date) : 'Entrega inmediata'}</p>
                            </div>
                            ${item.notes ? `
                                <div class="col-12 mb-3">
                                    <label class="form-label fw-bold text-muted">Notas</label>
                                    <p class="mb-0">${item.notes}</p>
                                </div>
                            ` : ''}
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Cotizado por</label>
                                <p class="mb-0">${item.quoted_by_name || '-'}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-muted">Fecha de Cotización</label>
                                <p class="mb-0">${Utils.formatDate(item.created_at)}</p>
                            </div>
                        </div>
                    `;

                    new bootstrap.Modal(document.getElementById('detailModal')).show();
                } else {
                    Utils.showToast(data.error || 'Error cargando detalle', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Utils.showToast('Error al cargar detalle', 'error');
            }
        }
    </script>
</body>
</html>
